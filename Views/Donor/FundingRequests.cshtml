@model IEnumerable<FundingRequestViewModel>
@{
    ViewData["Title"] = "Companies which applied for funding";
}

<h2>@ViewData["Title"]</h2>

<div class="form-group">
    <input type="text" id="searchInput" class="form-control" placeholder="Search for specific company..." />
</div>

<div id="fundingRequestsList">
    @foreach (var request in Model)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Company ID and Name: @request.CompanyID - @request.CompanyName</h5>
                <h6 class="card-subtitle mb-2 text-muted">Requested Amount: @request.RequestedAmount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("en-ZA"))</h6> <!-- Ensure ZAR formatting -->
                <p class="card-text"><strong>Project Description:</strong> @request.ProjectDescription</p>
                <p class="card-text"><strong>Project Impact:</strong> @request.ProjectImpact</p>
                <p class="card-text"><small class="text-muted">Submitted on @request.SubmittedAt.ToString("d")</small></p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#searchInput').on('input', function () {
                var searchTerm = $(this).val();

                if (searchTerm.length > 2) {
                    $.ajax({
                        url: '@Url.Action("SearchFundingRequests", "Donor")', // Ensure URL is correctly resolved
                        type: 'GET',
                        data: { term: searchTerm },
                        success: function (result) {
                            console.log(result); // Log to verify data is being returned
                            $('#fundingRequestsList').empty();

                            // Iterate over the result and append HTML with corrected property names
                            $.each(result, function (i, request) {
                                var requestHtml = '<div class="card mb-3">' +
                                    '<div class="card-body">' +
                                    '<h5 class="card-title">Company ID and Name: ' + request.CompanyID + ' - ' + request.CompanyName + '</h5>' +
                                    '<h6 class="card-subtitle mb-2 text-muted">Requested Amount: ' + new Intl.NumberFormat("en-ZA", { style: "currency", currency: "ZAR" }).format(request.RequestedAmount) + '</h6>' +
                                    '<p class="card-text"><strong>Project Description:</strong> ' + request.ProjectDescription + '</p>' +
                                    '<p class="card-text"><strong>Project Impact:</strong> ' + request.ProjectImpact + '</p>' +
                                    '<p class="card-text"><small class="text-muted">Submitted on ' + new Date(request.SubmittedAt).toLocaleDateString() + '</small></p>' +
                                    '</div></div>';
                                $('#fundingRequestsList').append(requestHtml);
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching data:", error); // Error handling
                        }
                    });
                } else {
                    $('#fundingRequestsList').empty(); // Clear list when input is too short
                    // Optionally reload the page or repopulate with initial data
                }
            });
        });
    </script>
}